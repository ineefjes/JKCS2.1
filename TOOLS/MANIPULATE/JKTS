#!/bin/bash

source ~/.JKCSusersetup.txt
scriptpath="$( cd "$(dirname "$0")" ; pwd -P )"
toolspath="$scriptpath/../"

# Default values
SLURM_TIME="128:00:00"
SLURM_PARTITION="q24,q28,q36,q40,q48,q64"
# SLURM_TIME="1:00:00"
# SLURM_PARTITION="qtest"
PYTHON_ARGS=()
XYZ=0
LOG=0
PKL=0

for arg in "$@"; do
  PYTHON_ARGS+=("$arg")
done

for arg in "$@"; do
  if [[ "$arg" == "-h" ]] || [[ "$arg" == "--help" ]]; then
    program_PYTHON "$toolspath/SCRIPTS/DATS.py" -h
    exit 0
  elif [[ "$arg" == "-test" ]]; then
    program_PYTHON "$toolspath/SCRIPTS/DATS.py" "${PYTHON_ARGS[@]}"
    exit 0
  elif [[ "$arg" == *.xyz ]]; then
    input_file="$arg"
    base_name="${input_file%.*}"
    XYZ=1
  elif [[ "$arg" == *.log ]]; then
    LOG=1
  elif [[ "$arg" == *.pkl ]]; then
    PKL=1
  fi
done


if [[ "$XYZ" -gt 0 ]]; then
    program_PYTHON "$toolspath/SCRIPTS/DATS.py" "${PYTHON_ARGS[@]}" -init
fi

directories=()
for dir in "$base_name"*; do
    if [ -d "$dir" ]; then
        directories+=("$dir")
    fi
done

reactants_dir="reactants"
if [ -d "$reactants_dir" ]; then
    directories+=("$reactants_dir")
fi


# Submit one array job for all directories
submit_array_job() {
  local SLURM_SCRIPT=$(mktemp /tmp/slurm-script.XXXXXX)

  cat > $SLURM_SCRIPT <<EOF
#!/bin/sh
#SBATCH --job-name=JKTS
#SBATCH --output=%A_%a_out
#SBATCH --error=%A_%a_err
#SBATCH --time=$SLURM_TIME
#SBATCH --partition=$SLURM_PARTITION
#SBATCH --ntasks=1
#SBATCH --cpus-per-task=1
#SBATCH --mem=2000
#SBATCH --array=1-${#directories[@]}%${#directories[@]}

DIR_INDEX=\$((\$SLURM_ARRAY_TASK_ID - 1))
DIRS=(${directories[@]})
cd \${DIRS[\$DIR_INDEX]}
source ~/.JKCSusersetup.txt
program_PYTHON "$toolspath/SCRIPTS/DATS.py" "${PYTHON_ARGS[@]}" 
EOF

  sbatch $SLURM_SCRIPT
  rm $SLURM_SCRIPT
}


submit_job() {
  local SLURM_SCRIPT=$(mktemp /tmp/slurm-script.XXXXXX)

  cat > $SLURM_SCRIPT <<EOF
#!/bin/sh
#SBATCH --job-name=JKTS
#SBATCH --output=%A_%a_out
#SBATCH --error=%A_%a_err
#SBATCH --time=$SLURM_TIME
#SBATCH --partition=$SLURM_PARTITION
#SBATCH --ntasks=1
#SBATCH --cpus-per-task=1
#SBATCH --mem=2000

source ~/.JKCSusersetup.txt
program_PYTHON "$toolspath/SCRIPTS/DATS.py" "${PYTHON_ARGS[@]}" 
EOF

  sbatch $SLURM_SCRIPT
  rm $SLURM_SCRIPT
}



if [ ${#directories[@]} -gt 0 ]; then
  submit_array_job
elif [ "$PKL" -gt 0 ] || [ "$LOG" -gt 0 ]; then
  submit_job
fi

